<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | CarbonPlay</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Tailwind + DaisyUI compiled stylesheet -->
  <link rel="stylesheet" href="../dist/styles.css" />
  <style>
    body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script>
    // Apply stored theme early
    (function(){
      const t = localStorage.getItem('theme') || 'carbonplay';
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>
  <!-- Simple favicon placeholder -->
  <link rel="icon" href="data:," />
  <meta name="robots" content="noindex" />
  <meta name="color-scheme" content="light dark" />
  <meta name="description" content="CarbonPlay Admin Console" />
</head>
<body>
  <div class="bg-base-200 min-h-screen">
    <!-- Header -->
    <header class="bg-base-100 border-b">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="text-primary text-2xl"><i class="fa-solid fa-shield-halved"></i></div>
          <div>
            <h1 class="text-xl md:text-2xl font-semibold">Admin Console</h1>
            <p class="text-xs md:text-sm text-base-content/60">Manage users, data, and content</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <a href="../../dashboard.html" class="btn btn-ghost hidden md:inline-flex"><i class="fa-solid fa-gauge mr-2"></i>Dashboard</a>
          <a href="analytics.html" class="btn btn-ghost hidden md:inline-flex"><i class="fa-solid fa-chart-pie mr-2"></i>Analytics</a>
          <a href="users-analytics.html" class="btn btn-ghost hidden md:inline-flex"><i class="fa-solid fa-users-line mr-2"></i>Users Analytics</a>
          <a href="ph-sectors.html" class="btn btn-ghost hidden md:inline-flex"><i class="fa-solid fa-layer-group mr-2"></i>PH Sectors</a>
          <button id="adminRefreshBtn" class="btn btn-ghost"><i class="fa-solid fa-rotate"></i></button>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">

      <!-- Tabs -->
      <div class="overflow-x-auto">
        <div class="tabs tabs-boxed w-max">
          <button class="tab tab-active" data-section="users"><i class="fa-solid fa-user mr-2"></i>Users</button>
          <button class="tab" data-section="profiles"><i class="fa-solid fa-id-badge mr-2"></i>Profiles</button>
          <button class="tab" data-section="challenges"><i class="fa-solid fa-medal mr-2"></i>Challenges</button>
          <button class="tab" data-section="userchalls"><i class="fa-solid fa-trophy mr-2"></i>User Challenges</button>
          <button class="tab" data-section="factors"><i class="fa-solid fa-flask mr-2"></i>Emission Factors</button>
          <button class="tab" data-section="scenarios"><i class="fa-solid fa-diagram-project mr-2"></i>Scenarios</button>
        </div>
      </div>

      <!-- Sections -->
      <section id="section-users" class="mt-6">
        <div class="card bg-base-100 shadow">
          <div class="card-body gap-4">
            <div class="flex flex-col md:flex-row md:items-center gap-3 md:justify-between">
              <div>
                <h2 class="card-title">Users</h2>
                <p class="text-sm text-base-content/60">Manage app users and roles</p>
              </div>
              <div class="flex items-center gap-2">
                <label class="input input-bordered flex items-center gap-2 w-64 bg-base-100">
                  <i class="fa-solid fa-magnifying-glass opacity-60"></i>
                  <input id="search-users" type="text" class="grow bg-base-100" placeholder="Search users..." />
                </label>
                <button class="btn btn-primary" data-action="open-modal" data-modal="modal-users" data-mode="create"><i class="fa-solid fa-plus mr-2"></i>Add User</button>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tbody-users">
                  <tr><td colspan="7" class="text-center text-base-content/60">No users loaded</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="section-profiles" class="mt-6 hidden">
        <div class="card bg-base-100 shadow">
          <div class="card-body gap-4">
            <div class="flex flex-col md:flex-row md:items-center gap-3 md:justify-between">
              <div>
                <h2 class="card-title">User Profiles</h2>
                <p class="text-sm text-base-content/60">Countries, households, and baselines</p>
              </div>
              <div class="flex items-center gap-2">
                <label class="input input-bordered flex items-center gap-2 w-64 bg-base-100">
                  <i class="fa-solid fa-magnifying-glass opacity-60"></i>
                  <input id="search-profiles" type="text" class="grow bg-base-100" placeholder="Search profiles..." />
                </label>
                <button class="btn btn-primary" data-action="open-modal" data-modal="modal-profiles" data-mode="create"><i class="fa-solid fa-plus mr-2"></i>Add Profile</button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>User</th>
                    <th>Country</th>
                    <th>Household</th>
                    <th>Baseline Calc.</th>
                    <th>Baseline CO₂e</th>
                    <th>Updated</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tbody-profiles">
                  <tr><td colspan="8" class="text-center text-base-content/60">No profiles loaded</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="section-challenges" class="mt-6 hidden">
        <div class="card bg-base-100 shadow">
          <div class="card-body gap-4">
            <div class="flex flex-col md:flex-row md:items-center gap-3 md:justify-between">
              <div>
                <h2 class="card-title">Challenges</h2>
                <p class="text-sm text-base-content/60">Gamified reduction goals</p>
              </div>
              <div class="flex items-center gap-2">
                <button class="btn btn-primary" data-action="open-modal" data-modal="modal-challenges" data-mode="create"><i class="fa-solid fa-plus mr-2"></i>New Challenge</button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Target</th>
                    <th>Duration</th>
                    <th>Badge</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tbody-challenges">
                  <tr><td colspan="8" class="text-center text-base-content/60">No challenges loaded</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="section-userchalls" class="mt-6 hidden">
        <div class="card bg-base-100 shadow">
          <div class="card-body gap-4">
            <div class="flex flex-col md:flex-row md:items-center gap-3 md:justify-between">
              <div>
                <h2 class="card-title">User Challenges</h2>
                <p class="text-sm text-base-content/60">Enrollments and admin actions</p>
              </div>
              <div class="flex items-center gap-2">
                <button class="btn" data-action="refresh" data-target="userchalls"><i class="fa-solid fa-arrows-rotate mr-2"></i>Refresh</button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>User</th>
                    <th>Challenge</th>
                    <th>Progress</th>
                    <th>Started</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tbody-userchalls">
                  <tr><td colspan="7" class="text-center text-base-content/60">No user challenges loaded</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="section-factors" class="mt-6 hidden">
        <div class="card bg-base-100 shadow">
          <div class="card-body gap-4">
            <div class="flex flex-col md:flex-row md:items-center gap-3 md:justify-between">
              <div>
                <h2 class="card-title">Emission Factors</h2>
                <p class="text-sm text-base-content/60">Maintain factors per category and region</p>
              </div>
              <div class="flex items-center gap-2">
                <button class="btn btn-primary" data-action="open-modal" data-modal="modal-factors" data-mode="create"><i class="fa-solid fa-plus mr-2"></i>Add Factor</button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Category</th>
                    <th>Activity</th>
                    <th>Region</th>
                    <th>CO₂e / Unit</th>
                    <th>Unit</th>
                    <th>Source</th>
                    <th>Updated</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tbody-factors">
                  <tr><td colspan="9" class="text-center text-base-content/60">No factors loaded</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="section-scenarios" class="mt-6 hidden">
        <div class="card bg-base-100 shadow">
          <div class="card-body gap-4">
            <div class="flex flex-col md:flex-row md:items-center gap-3 md:justify-between">
              <div>
                <h2 class="card-title">Scenarios</h2>
                <p class="text-sm text-base-content/60">User-created what-if analyses</p>
              </div>
              <div class="flex items-center gap-2">
                <button class="btn" data-action="refresh" data-target="scenarios"><i class="fa-solid fa-arrows-rotate mr-2"></i>Refresh</button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>User</th>
                    <th>Name</th>
                    <th>Total CO₂e</th>
                    <th>vs Baseline</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tbody-scenarios">
                  <tr><td colspan="8" class="text-center text-base-content/60">No scenarios loaded</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Modals: Users -->
  <dialog id="modal-users" class="modal">
    <div class="modal-box">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
      <h3 class="font-semibold mb-4" id="modal-users-title">Add User</h3>
      <form id="form-users" class="grid gap-3">
        <input type="hidden" name="id" />
        <label class="form-control">
          <div class="label"><span class="label-text">Username</span></div>
          <input name="username" type="text" class="input input-bordered" required />
        </label>
        <label class="form-control">
          <div class="label"><span class="label-text">Email</span></div>
          <input name="email" type="email" class="input input-bordered" required />
        </label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="form-control">
            <div class="label"><span class="label-text">Password</span></div>
            <input name="password" type="password" class="input input-bordered" placeholder="Set or leave blank when editing" />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Role</span></div>
            <select name="role" class="select select-bordered">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
          </label>
        </div>
        <label class="label cursor-pointer justify-start gap-3">
          <input name="is_active" type="checkbox" class="checkbox" checked />
          <span class="label-text">Active</span>
        </label>
        <div class="modal-action">
          <button type="submit" class="btn btn-primary">Save</button>
          <form method="dialog"><button class="btn">Cancel</button></form>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Modals: Profiles -->
  <dialog id="modal-profiles" class="modal">
    <div class="modal-box">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
      <h3 class="font-semibold mb-4" id="modal-profiles-title">Add Profile</h3>
      <form id="form-profiles" class="grid gap-3">
        <input type="hidden" name="id" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="form-control">
            <div class="label"><span class="label-text">User ID</span></div>
            <input name="user_id" type="number" class="input input-bordered" required />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Country</span></div>
            <input name="country" type="text" class="input input-bordered" value="US" />
          </label>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="form-control">
            <div class="label"><span class="label-text">Household Size</span></div>
            <input name="household_size" type="number" class="input input-bordered" value="1" />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Baseline CO₂e</span></div>
            <input name="baseline_co2e" type="number" step="0.01" class="input input-bordered" value="0" />
          </label>
        </div>
        <label class="label cursor-pointer justify-start gap-3">
          <input name="baseline_calculated" type="checkbox" class="checkbox" />
          <span class="label-text">Baseline Calculated</span>
        </label>
        <div class="modal-action">
          <button type="submit" class="btn btn-primary">Save</button>
          <form method="dialog"><button class="btn">Cancel</button></form>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Modals: Challenges -->
  <dialog id="modal-challenges" class="modal">
    <div class="modal-box max-w-2xl">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
      <h3 class="font-semibold mb-4" id="modal-challenges-title">New Challenge</h3>
      <form id="form-challenges" class="grid gap-3">
        <input type="hidden" name="id" />
        <label class="form-control">
          <div class="label"><span class="label-text">Name</span></div>
          <input name="name" type="text" class="input input-bordered" required />
        </label>
        <label class="form-control">
          <div class="label"><span class="label-text">Description</span></div>
          <textarea name="description" class="textarea textarea-bordered" rows="2"></textarea>
        </label>
        
        <div class="divider text-sm">Challenge Type & Target</div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="form-control">
            <div class="label"><span class="label-text">Challenge Type</span></div>
            <select name="challenge_type" class="select select-bordered" required>
              <option value="daily_limit">Daily Limit - Stay under X kg/day</option>
              <option value="total_limit">Total Limit - Stay under X kg total</option>
              <option value="activity_count">Activity Count - Log X activities</option>
              <option value="consecutive_days">Consecutive Days - X days under limit</option>
            </select>
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Target Value</span></div>
            <input name="target_value" type="number" step="0.01" class="input input-bordered" placeholder="e.g., 5.0" required />
            <div class="label"><span class="label-text-alt">kg CO₂e or count (depends on type)</span></div>
          </label>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <label class="form-control">
            <div class="label"><span class="label-text">Duration (days)</span></div>
            <input name="duration_days" type="number" class="input input-bordered" value="7" required />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Badge Name</span></div>
            <input name="badge_name" type="text" class="input input-bordered" placeholder="Optional" />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Unit</span></div>
            <input name="target_unit" type="text" class="input input-bordered" value="kg_co2e" />
          </label>
        </div>
        
        <div class="alert alert-info text-xs">
          <i class="fa-solid fa-circle-info"></i>
          <div>
            <strong>Daily Limit:</strong> Avg emissions/day must stay under target_value<br>
            <strong>Total Limit:</strong> Total emissions for duration must stay under target_value<br>
            <strong>Activity Count:</strong> Must log at least target_value activities<br>
            <strong>Consecutive Days:</strong> Requires target_value consecutive low-emission days
          </div>
        </div>
        
        <label class="label cursor-pointer justify-start gap-3">
          <input name="is_active" type="checkbox" class="checkbox" checked />
          <span class="label-text">Active (visible to users)</span>
        </label>
        <div class="modal-action">
          <button type="submit" class="btn btn-primary">Save Challenge</button>
          <form method="dialog"><button class="btn">Cancel</button></form>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Modals: Emission Factors -->
  <dialog id="modal-factors" class="modal">
    <div class="modal-box">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
      <h3 class="font-semibold mb-4" id="modal-factors-title">Add Factor</h3>
      <form id="form-factors" class="grid gap-3">
        <input type="hidden" name="id" />
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <label class="form-control">
            <div class="label"><span class="label-text">Category</span></div>
            <select name="category" class="select select-bordered">
              <option value="transport">transport</option>
              <option value="diet">diet</option>
              <option value="energy">energy</option>
              <option value="waste">waste</option>
              <option value="other">other</option>
            </select>
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Activity Type</span></div>
            <input name="activity_type" type="text" class="input input-bordered" required />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Region</span></div>
            <input name="region" type="text" class="input input-bordered" value="global" />
          </label>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <label class="form-control">
            <div class="label"><span class="label-text">CO₂e per Unit</span></div>
            <input name="co2e_per_unit" type="number" step="0.000001" class="input input-bordered" required />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Unit</span></div>
            <input name="unit" type="text" class="input input-bordered" placeholder="e.g., kg_per_mile" required />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Source</span></div>
            <input name="source" type="text" class="input input-bordered" placeholder="climatiq / coolclimate" />
          </label>
        </div>
        <div class="modal-action">
          <button type="submit" class="btn btn-primary">Save</button>
          <form method="dialog"><button class="btn">Cancel</button></form>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Modals: Scenarios (basic create/edit) -->
  <dialog id="modal-scenarios" class="modal">
    <div class="modal-box">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
      <h3 class="font-semibold mb-4" id="modal-scenarios-title">Edit Scenario</h3>
      <form id="form-scenarios" class="grid gap-3">
        <input type="hidden" name="id" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="form-control">
            <div class="label"><span class="label-text">User ID</span></div>
            <input name="user_id" type="number" class="input input-bordered" required />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Name</span></div>
            <input name="name" type="text" class="input input-bordered" required />
          </label>
        </div>
        <label class="form-control">
          <div class="label"><span class="label-text">Description</span></div>
          <textarea name="description" class="textarea textarea-bordered" rows="3"></textarea>
        </label>
        <label class="label cursor-pointer justify-start gap-3">
          <input name="is_active" type="checkbox" class="checkbox" checked />
          <span class="label-text">Active</span>
        </label>
        <div class="modal-action">
          <button type="submit" class="btn btn-primary">Save</button>
          <form method="dialog"><button class="btn">Cancel</button></form>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <script src="../js/admin-notify.js"></script>
  <script src="../js/admin.js"></script>
  <script src="../js/admin-climatiq-helper.js"></script>
  <script src="../js/admin-activity-generator.js"></script>
  
</body>
</html>
